<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
</head>
<body>
  <div class="admin-layout">
    <aside class="sidebar">
      <div class="brand">
        <a href="/" class="brand-link">MedPredict AI</a>
      </div>
      <nav class="nav flex-column">
        <a class="nav-link active" href="{{ url_for('admin_panel') }}">Dashboard</a>
        <a class="nav-link" href="#users-section">Users</a>
        <a class="nav-link" href="#predictions-section">Predictions</a>
        <a class="nav-link" href="/about">About</a>
      </nav>
    </aside>

    <main class="main-content">
      <header class="topbar d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
          <h4 class="mb-0">Admin Panel</h4>
          <small class="text-muted">Welcome, {{ session['name'] }}</small>
        </div>
        <div class="actions">
          <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm">Logout</a>
        </div>
      </header>

      <section class="container-fluid p-4">
        <!-- Stats cards -->
        <div class="row g-3">
          <div class="col-md-4">
            <div class="card stat-card">
              <div class="card-body">
                <h6>Users</h6>
                <h2>{{ users_count or users|length }}</h2>
                <small class="text-muted">Total registered users</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card stat-card">
              <div class="card-body">
                <h6>Predictions</h6>
                <h2>{{ predictions_count or predictions|length }}</h2>
                <small class="text-muted">Total predictions</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card stat-card">
              <div class="card-body">
                <h6>Export</h6>
                <div class="d-flex gap-2 mt-2">
                  <a href="{{ url_for('admin_export', table='users') }}" class="btn btn-sm btn-primary">Download Users CSV</a>
                  <a href="{{ url_for('admin_export', table='predictions') }}" class="btn btn-sm btn-secondary">Download Predictions CSV</a>
                </div>
                <small class="text-muted d-block mt-2">Exports current DB snapshot</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Users table -->
        <div id="users-section" class="table-container mt-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Users</h5>
            <div class="d-flex gap-2">
              <input id="userSearch" class="form-control form-control-sm" placeholder="Search users..." />
            </div>
          </div>

          <div class="table-responsive">
            <table id="usersTable" class="table table-striped table-sm align-middle">
              <thead class="table-dark">
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Created At</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for user in users %}
                <tr>
                  <td>{{ user[0] }}</td>
                  <td>{{ user[1] }}</td>
                  <td>{{ user[2] }}</td>
                  <td>{{ user[3] }}</td>
                  <td>{{ user[4] if user|length > 4 else '' }}</td>
                  <td class="actions-col">
                    <a href="{{ url_for('edit_user', user_id=user[0]) }}" class="btn btn-sm btn-warning">Edit</a>
                    <form action="{{ url_for('delete_user', user_id=user[0]) }}" method="post" onsubmit="return confirm('Delete this user?');" style="display:inline;">
                      <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Predictions table -->
        <div id="predictions-section" class="table-container mt-4">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">Prediction History</h5>
            <div class="d-flex gap-2">
              <input id="predSearch" class="form-control form-control-sm" placeholder="Search predictions..." />
            </div>
          </div>

          <div class="table-responsive">
            <table id="predTable" class="table table-striped table-sm align-middle">
              <thead class="table-dark">
                <tr>
                  <th>ID</th>
                  <th>User Email</th>
                  <th>Prediction</th>
                  <th>Symptoms</th>
                  <th>Timestamp</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for p in predictions %}
                <tr>
                  <td>{{ p[0] }}</td>
                  <td>{{ p[1] }}</td>
                  <td>{{ p[2] }}</td>
                  <td class="text-break" style="max-width:300px;">{{ p[3] }}</td>
                  <td>{{ p[4] }}</td>
                  <td>
                    <form action="{{ url_for('delete_prediction', prediction_id=p[0]) }}" method="post" onsubmit="return confirm('Delete this prediction?');" style="display:inline;">
                      <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

      </section>

      <footer class="footer text-center py-3">
        <small>Â© 2025 MedPredict AI</small>
      </footer>
    </main>
  </div>

  <script>
    // Simple client-side table search
    function filterTable(inputId, tableId, colCount) {
      const input = document.getElementById(inputId);
      input.addEventListener('input', () => {
        const filter = input.value.toLowerCase();
        const rows = document.querySelectorAll(`#${tableId} tbody tr`);
        rows.forEach(r => {
          r.style.display = Array.from(r.cells).slice(0, colCount).map(td => td.textContent.toLowerCase()).join(' ').includes(filter) ? '' : 'none';
        });
      });
    }
    filterTable('userSearch', 'usersTable', 5);
    filterTable('predSearch', 'predTable', 5);
  </script>
</body>
</html>
